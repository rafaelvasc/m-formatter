<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>M Formatter - Formatador de C√≥digo Power Query</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      background: #0d1117;
      color: #e6edf3;
    }
    header {
      background: linear-gradient(135deg, #238636 0%, #196127 100%);
      color: white;
      padding: 20px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3);
    }
    .header-title {
      font-size: 32px;
      font-weight: 700;
      margin: 0;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
    }
    .header-subtitle {
      font-size: 16px;
      margin: 5px 0 0 0;
      opacity: 0.9;
    }
    .main-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin: 20px;
      gap: 20px;
    }
    .editor-section {
      flex: 1;
      display: flex;
      flex-direction: column;
      border: 1px solid #30363d;
      border-radius: 12px;
      overflow: hidden;
      background: #161b22;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    .editor-header {
      background: #21262d;
      padding: 12px 20px;
      border-bottom: 1px solid #30363d;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .editor-title {
      font-weight: 600;
      font-size: 14px;
      color: #f0f6fc;
    }
    .editor-stats {
      font-size: 12px;
      color: #7d8590;
    }
    .editor-content {
      display: flex;
      flex: 1;
      min-height: 400px;
    }
    .line-numbers {
      background: #0d1117;
      padding: 20px 12px;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      color: #6e7681;
      border-right: 1px solid #30363d;
      user-select: none;
      min-width: 60px;
      text-align: right;
    }
    #editor {
      flex: 1;
      font-family: 'SF Mono', 'Monaco', 'Inconsolata', 'Fira Code', 'Consolas', monospace;
      font-size: 13px;
      line-height: 1.6;
      padding: 20px;
      background: #0d1117;
      color: #e6edf3;
      border: none;
      outline: none;
      resize: none;
      tab-size: 4;
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
    }
    #editor:focus {
      background: #161b22;
    }
    .controls {
      background: #21262d;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid #30363d;
      gap: 15px;
    }
    .controls-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .controls-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .btn-primary {
      padding: 10px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      background: linear-gradient(180deg, #238636 0%, #196127 100%);
      color: white;
      border: 1px solid rgba(240,246,252,0.1);
      border-radius: 8px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary:hover {
      background: linear-gradient(180deg, #2ea043 0%, #238636 100%);
      border-color: rgba(240,246,252,0.2);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    .btn-secondary {
      padding: 8px 16px;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      background: #21262d;
      color: #f0f6fc;
      border: 1px solid #30363d;
      border-radius: 6px;
      transition: all 0.2s;
    }
    .btn-secondary:hover {
      background: #30363d;
      border-color: #484f58;
    }
    .btn:disabled {
      background: #6e7681 !important;
      cursor: not-allowed !important;
      border-color: #30363d !important;
      transform: none !important;
    }
    .loading {
      opacity: 0.7;
    }
    .status {
      font-size: 12px;
      color: #7d8590;
      display: flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
    }
    .status.success { color: #3fb950; }
    .status.error { color: #f85149; }
    .status.warning { color: #d29922; }
    .shortcut-hint {
      font-size: 11px;
      color: #6e7681;
      background: #21262d;
      padding: 4px 8px;
      border-radius: 4px;
      border: 1px solid #30363d;
    }
    .format-options {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    .format-options label {
      font-size: 12px;
      color: #f0f6fc;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .format-options input[type="checkbox"] {
      accent-color: #238636;
    }
    .stats-info {
      display: flex;
      gap: 15px;
      font-size: 11px;
      color: #7d8590;
    }
    
    /* Syntax highlighting simulation */
    .keyword { color: #ff7b72; }
    .string { color: #a5d6ff; }
    .function { color: #d2a8ff; }
    .comment { color: #8b949e; }
  </style>
</head>
<body>
  <header>
    <h1 class="header-title">üé® M Formatter</h1>
    <p class="header-subtitle">Formatador e Identador de C√≥digo Power Query M</p>
  </header>
  
  <div class="main-container">
    <div class="editor-section">
      <div class="editor-header">
        <div class="editor-title">üìù Editor de C√≥digo M</div>
        <div class="editor-stats">
          <div class="stats-info">
            <span id="lineCount">Linhas: 0</span>
            <span id="charCount">Caracteres: 0</span>
          </div>
        </div>
      </div>
      <div class="editor-content">
        <div id="lineNumbers" class="line-numbers"></div>
        <textarea id="editor" placeholder="Cole ou digite seu c√≥digo Power Query M aqui...

Exemplo:
let
Source = Excel.Workbook(File.Contents(&quot;C:\dados.xlsx&quot;)),
Sheet1 = Source{[Name=&quot;Planilha1&quot;]}[Data],
PromotedHeaders = Table.PromoteHeaders(Sheet1),
ChangedTypes = Table.TransformColumnTypes(PromotedHeaders,{{&quot;ID&quot;, Int64.Type}, {&quot;Nome&quot;, type text}})
in
ChangedTypes">let
    Source = Excel.Workbook(File.Contents("C:\dados.xlsx")),
    Sheet1 = Source{[Name="Planilha1"]}[Data],
    PromotedHeaders = Table.PromoteHeaders(Sheet1),
    ChangedTypes = Table.TransformColumnTypes(PromotedHeaders,{{"ID", Int64.Type}, {"Nome", type text}})
in
    ChangedTypes</textarea>
      </div>
    </div>
    
    <div class="controls">
      <div class="controls-left">
        <button id="formatButton" class="btn-primary">
          ‚ú® Formatar & Identar
        </button>
        <button id="clearButton" class="btn-secondary">üóëÔ∏è Limpar</button>
        
        <div class="format-options">
          <label>
            <input type="checkbox" id="addSpaces" checked>
            Espa√ßos ao redor de =
          </label>
          <label>
            <input type="checkbox" id="breakLongLines" checked>
            Quebrar linhas longas
          </label>
        </div>
      </div>
      
      <div class="controls-right">
        <div class="shortcut-hint">Ctrl+Enter para formatar</div>
        <div id="status" class="status"></div>
      </div>
    </div>
  </div>

  <script>
    const editor = document.getElementById('editor');
    const formatButton = document.getElementById('formatButton');
    const clearButton = document.getElementById('clearButton');
    const statusElement = document.getElementById('status');
    const lineNumbers = document.getElementById('lineNumbers');
    const lineCount = document.getElementById('lineCount');
    const charCount = document.getElementById('charCount');
    const addSpaces = document.getElementById('addSpaces');
    const breakLongLines = document.getElementById('breakLongLines');

    // Fun√ß√£o para mostrar status
    function showStatus(message, type = 'info') {
      statusElement.textContent = message;
      statusElement.className = `status ${type}`;
      
      if (type === 'success' || type === 'error' || type === 'warning') {
        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = 'status';
        }, 3000);
      }
    }

    // Fun√ß√£o para atualizar estat√≠sticas
    function updateStats() {
      const text = editor.value;
      const lines = text.split('\n').length;
      const chars = text.length;
      
      lineCount.textContent = `Linhas: ${lines}`;
      charCount.textContent = `Caracteres: ${chars}`;
    }

    // Fun√ß√£o para atualizar n√∫meros das linhas
    function updateLineNumbers() {
      const lines = editor.value.split('\n');
      const lineNumbersHtml = lines.map((_, index) => 
        `<div>${index + 1}</div>`
      ).join('');
      lineNumbers.innerHTML = lineNumbersHtml;
      updateStats();
    }

    // Formatador principal de c√≥digo M
    function formatMCode(code) {
      const options = {
        addSpaces: addSpaces.checked,
        breakLongLines: breakLongLines.checked
      };
      
      const lines = code.split('\n');
      const formatted = [];
      let indentLevel = 0;
      let inLetBlock = false;
      
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        
        // Pula linhas vazias
        if (!line) {
          formatted.push('');
          continue;
        }
        
        // Detecta in√≠cio do bloco let
        if (line.toLowerCase().startsWith('let')) {
          formatted.push(line);
          inLetBlock = true;
          indentLevel = 1;
          continue;
        }
        
        // Detecta final do bloco (in)
        if (line.toLowerCase().startsWith('in')) {
          formatted.push(line);
          inLetBlock = false;
          indentLevel = 0;
          continue;
        }
        
        // Processa linhas com atribui√ß√£o
        if (line.includes('=') && inLetBlock) {
          // Adiciona espa√ßos ao redor do =
          if (options.addSpaces) {
            line = line.replace(/([^=!<>])\s*=\s*([^=])/g, '$1 = $2');
          }
          
          // Quebra linhas muito longas
          if (options.breakLongLines && line.length > 80) {
            line = breakLongLine(line);
          }
          
          // Aplica indenta√ß√£o
          const indent = '    '.repeat(indentLevel);
          
          if (line.includes('\n')) {
            // Linha j√° foi quebrada
            const subLines = line.split('\n');
            formatted.push(indent + subLines[0]);
            for (let j = 1; j < subLines.length; j++) {
              formatted.push('        ' + subLines[j].trim());
            }
          } else {
            formatted.push(indent + line);
          }
        } else if (inLetBlock) {
          // Linhas de continua√ß√£o
          const indent = '        ';
          formatted.push(indent + line);
        } else {
          // Fora do bloco let/in
          formatted.push(line);
        }
      }
      
      return formatted.join('\n');
    }
    
    // Quebra linhas longas de forma inteligente
    function breakLongLine(line) {
      // Procura por pontos de quebra naturais
      const breakPoints = [
        { pattern: /,\s*(?=\w)/, replacement: ',\n' },
        { pattern: /\(\s*(?=\w)/, replacement: '(\n' },
        { pattern: /\s+and\s+/, replacement: '\nand ' },
        { pattern: /\s+or\s+/, replacement: '\nor ' }
      ];
      
      for (const bp of breakPoints) {
        if (line.match(bp.pattern)) {
          return line.replace(bp.pattern, bp.replacement);
        }
      }
      
      return line;
    }

    // Fun√ß√£o principal de formata√ß√£o
    function formatCode() {
      const rawCode = editor.value;
      
      if (!rawCode.trim()) {
        showStatus('‚ö†Ô∏è Nenhum c√≥digo para formatar', 'warning');
        return;
      }

      // Feedback visual
      formatButton.disabled = true;
      formatButton.classList.add('loading');
      formatButton.innerHTML = '‚è≥ Formatando...';
      showStatus('üé® Formatando c√≥digo...');

      try {
        const formatted = formatMCode(rawCode);
        editor.value = formatted;
        updateLineNumbers();
        showStatus('‚úÖ C√≥digo formatado com sucesso!', 'success');
      } catch (error) {
        console.error('Erro na formata√ß√£o:', error);
        showStatus('‚ùå Erro durante a formata√ß√£o', 'error');
      } finally {
        // Reabilita o bot√£o
        setTimeout(() => {
          formatButton.disabled = false;
          formatButton.classList.remove('loading');
          formatButton.innerHTML = '‚ú® Formatar & Identar';
        }, 500);
      }
    }

    // Event listeners
    formatButton.addEventListener('click', formatCode);
    
    clearButton.addEventListener('click', () => {
      if (confirm('Tem certeza que deseja limpar todo o c√≥digo?')) {
        editor.value = '';
        updateLineNumbers();
        showStatus('üóëÔ∏è Editor limpo', 'success');
      }
    });

    // Atalhos de teclado
    editor.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        formatCode();
      }
      
      // Tab para inserir 4 espa√ßos
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
        this.selectionStart = this.selectionEnd = start + 4;
        updateLineNumbers();
      }
    });

    // Atualiza interface quando conte√∫do muda
    editor.addEventListener('input', updateLineNumbers);
    
    editor.addEventListener('scroll', function() {
      lineNumbers.scrollTop = this.scrollTop;
    });

    // Inicializa√ß√£o
    updateLineNumbers();
    showStatus('üí° Pronto! Cole seu c√≥digo M e clique em Formatar');
  </script>
</body>
</html>
