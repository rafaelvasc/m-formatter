<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Power Query Formatter</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      display: flex;
      flex-direction: column;
      font-family: "Segoe UI", sans-serif;
      background: #0d1117;
      color: #e6edf3;
    }
    header {
      background: #161b22;
      color: #e6edf3;
      padding: 15px 20px;
      text-align: center;
      font-size: 20px;
      font-weight: 600;
      border-bottom: 1px solid #30363d;
      box-shadow: 0 1px 3px rgba(0,0,0,0.12);
    }
    .editor-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin: 20px;
      border: 1px solid #30363d;
      border-radius: 8px;
      overflow: hidden;
      background: #0d1117;
    }
    #editor {
      flex: 1;
      min-height: 400px;
      font-family: 'Cascadia Code', 'Fira Code', 'Monaco', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.5;
      padding: 20px;
      background: #0d1117;
      color: #e6edf3;
      border: none;
      outline: none;
      resize: none;
      tab-size: 4;
      white-space: pre;
      overflow-wrap: normal;
      overflow-x: auto;
    }
    #editor:focus {
      background: #161b22;
    }
    .controls {
      background: #161b22;
      padding: 15px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-top: 1px solid #30363d;
      gap: 15px;
    }
    .controls-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .controls-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    button {
      padding: 8px 16px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      background: linear-gradient(180deg, #238636 0%, #196127 100%);
      color: white;
      border: 1px solid rgba(240,246,252,0.1);
      border-radius: 6px;
      transition: all 0.2s;
    }
    button:hover {
      background: linear-gradient(180deg, #2ea043 0%, #238636 100%);
      border-color: rgba(240,246,252,0.2);
    }
    button:active {
      background: #196127;
      transform: translateY(1px);
    }
    button:disabled {
      background: #6e7681;
      cursor: not-allowed;
      border-color: #30363d;
    }
    .loading {
      opacity: 0.7;
    }
    .status {
      font-size: 12px;
      color: #7d8590;
      display: flex;
      align-items: center;
      gap: 5px;
    }
    .status.error {
      color: #f85149;
    }
    .status.success {
      color: #3fb950;
    }
    .line-numbers {
      background: #161b22;
      padding: 20px 10px;
      font-family: 'Cascadia Code', 'Fira Code', 'Monaco', 'Consolas', monospace;
      font-size: 14px;
      line-height: 1.5;
      color: #7d8590;
      border-right: 1px solid #30363d;
      user-select: none;
      min-width: 50px;
      text-align: right;
    }
    .editor-content {
      display: flex;
      flex: 1;
    }
    .shortcut-hint {
      font-size: 11px;
      color: #7d8590;
      font-style: italic;
    }
  </style>
</head>
<body>
  <header>‚ö° Power Query Formatter</header>
  <div class="editor-container">
    <div class="editor-content">
      <div id="lineNumbers" class="line-numbers"></div>
      <textarea id="editor" placeholder="Cole seu c√≥digo Power Query M aqui...">let
    Source = {"I", "am", "a", "demo", "query", "for", "powerqueryformatter!", "Hit", "format", "to", "make", "me", "pretty"},
    #"Convert to Table" = Table.FromList(Source, Splitter.SplitByNothing(), null, null, ExtraValues.Error),
    #"Changed type" = Table.TransformColumnTypes(#"Convert to Table", {{"Column1", type text}}),
    #"Rename Columns" = Table.RenameColumns(#"Changed type", {{"Column1", "Words"}}),
    #"Added Index Column" = Table.AddIndexColumn(#"Rename Columns", "Index", 0, 1, Int64.Type)
in
    #"Added Index Column"</textarea>
    </div>
  </div>
  <div class="controls">
    <div class="controls-left">
      <button id="formatButton">üé® Formatar C√≥digo M</button>
      <button id="localFormatButton">üîß Formatar Local</button>
      <div class="shortcut-hint">Ctrl+Enter</div>
    </div>
    <div class="controls-right">
      <div id="status" class="status"></div>
    </div>
  </div>

  <script>
    const editor = document.getElementById('editor');
    const formatButton = document.getElementById('formatButton');
    const localFormatButton = document.getElementById('localFormatButton');
    const statusElement = document.getElementById('status');
    const lineNumbers = document.getElementById('lineNumbers');

    // Fun√ß√£o para mostrar status
    function showStatus(message, type = 'info') {
      statusElement.textContent = message;
      statusElement.className = `status ${type}`;
      
      if (type === 'success' || type === 'error') {
        setTimeout(() => {
          statusElement.textContent = '';
          statusElement.className = 'status';
        }, 3000);
      }
    }

    // Fun√ß√£o para atualizar n√∫meros das linhas
    function updateLineNumbers() {
      const lines = editor.value.split('\n');
      const lineNumbersHtml = lines.map((_, index) => 
        `<div>${index + 1}</div>`
      ).join('');
      lineNumbers.innerHTML = lineNumbersHtml;
    }

    // Fun√ß√£o para formatar o c√≥digo
    async function formatCode() {
      const rawCode = editor.value;
      
      if (!rawCode.trim()) {
        showStatus('Nenhum c√≥digo para formatar', 'error');
        return;
      }

      // Desabilita o bot√£o e mostra loading
      formatButton.disabled = true;
      formatButton.classList.add('loading');
      formatButton.textContent = '‚è≥ Formatando...';
      showStatus('Tentando formatar online...');

      try {
        // Timeout para a requisi√ß√£o
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), 10000);

        const response = await fetch('https://m-formatter.azurewebsites.net/api/v2/format', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
          },
          body: JSON.stringify({ text: rawCode }),
          signal: controller.signal
        });

        clearTimeout(timeoutId);

        if (!response.ok) {
          throw new Error(`Servidor retornou erro ${response.status}`);
        }

        const data = await response.json();
        
        if (data.formattedText) {
          editor.value = data.formattedText;
          updateLineNumbers();
          showStatus('‚úÖ C√≥digo formatado online com sucesso!', 'success');
        } else {
          throw new Error('Resposta inv√°lida do servidor');
        }

      } catch (error) {
        console.log('API indispon√≠vel, usando formata√ß√£o local:', error.message);
        
        // Sempre usa formata√ß√£o local quando API falha
        showStatus('üîß Formatando localmente...', 'info');
        
        try {
          const localFormatted = advancedLocalFormat(rawCode);
          editor.value = localFormatted;
          updateLineNumbers();
          showStatus('‚úÖ Formatado localmente (API indispon√≠vel)', 'success');
        } catch (fallbackError) {
          showStatus('‚ùå Erro na formata√ß√£o local', 'error');
        }
      } finally {
        // Reabilita o bot√£o
        formatButton.disabled = false;
        formatButton.classList.remove('loading');
        formatButton.textContent = 'üé® Formatar C√≥digo M';
      }
    }

    // Formata√ß√£o local avan√ßada
    function advancedLocalFormat(code) {
      const lines = code.split('\n');
      const formatted = [];
      let indentLevel = 0;
      let inTableExpression = false;
      
      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        
        if (!line) {
          formatted.push('');
          continue;
        }
        
        // In√≠cio do bloco let
        if (line.startsWith('let')) {
          formatted.push(line);
          indentLevel = 1;
          continue;
        }
        
        // Final do bloco in
        if (line.startsWith('in')) {
          indentLevel = 0;
          formatted.push(line);
          continue;
        }
        
        // Detecta express√µes Table
        if (line.includes('Table.') || line.includes('#"')) {
          inTableExpression = true;
        }
        
        // Linhas com atribui√ß√£o
        if (line.includes('=')) {
          // Remove espa√ßos extras ao redor do =
          line = line.replace(/\s*=\s*/, ' = ');
          
          // Indenta√ß√£o baseada no contexto
          let indent = '    '.repeat(indentLevel);
          
          // Adiciona quebras de linha em fun√ß√µes longas
          if (line.length > 100 && inTableExpression) {
            line = formatLongTableExpression(line);
          }
          
          formatted.push(indent + line);
        } else {
          // Linhas de continua√ß√£o
          let indent = '    '.repeat(indentLevel + 1);
          formatted.push(indent + line);
        }
        
        // Reset da detec√ß√£o de tabela se a linha termina com )
        if (line.endsWith(')') || line.endsWith(',')) {
          inTableExpression = false;
        }
      }
      
      return formatted.join('\n');
    }
    
    // Formata express√µes Table longas
    function formatLongTableExpression(line) {
      // Quebra linhas longas em par√¢metros de fun√ß√µes
      if (line.includes('Table.') && line.includes('(') && line.includes(',')) {
        const parts = line.split('(');
        const functionName = parts[0] + '(';
        const params = parts[1].replace(')', '');
        
        if (params.includes(',')) {
          const paramList = params.split(',').map(p => p.trim());
          if (paramList.length > 2) {
            return functionName + '\n        ' + paramList.join(',\n        ') + '\n    )';
          }
        }
      }
      
      return line;
    }

    // Event listeners
    formatButton.addEventListener('click', formatCode);
    localFormatButton.addEventListener('click', () => {
      const rawCode = editor.value;
      if (!rawCode.trim()) {
        showStatus('Nenhum c√≥digo para formatar', 'error');
        return;
      }
      
      showStatus('üîß Formatando localmente...');
      try {
        const formatted = advancedLocalFormat(rawCode);
        editor.value = formatted;
        updateLineNumbers();
        showStatus('‚úÖ Formatado localmente!', 'success');
      } catch (error) {
        showStatus('‚ùå Erro na formata√ß√£o local', 'error');
      }
    });

    // Atalho de teclado
    editor.addEventListener('keydown', function(e) {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
        e.preventDefault();
        formatCode();
      }
      
      // Tab para inserir 4 espa√ßos
      if (e.key === 'Tab') {
        e.preventDefault();
        const start = this.selectionStart;
        const end = this.selectionEnd;
        this.value = this.value.substring(0, start) + '    ' + this.value.substring(end);
        this.selectionStart = this.selectionEnd = start + 4;
        updateLineNumbers();
      }
    });

    // Atualiza n√∫meros das linhas quando o conte√∫do muda
    editor.addEventListener('input', updateLineNumbers);
    editor.addEventListener('scroll', function() {
      lineNumbers.scrollTop = this.scrollTop;
    });

    // Sincroniza scroll entre editor e n√∫meros das linhas
    lineNumbers.addEventListener('scroll', function() {
      editor.scrollTop = this.scrollTop;
    });

    // Inicializa os n√∫meros das linhas
    updateLineNumbers();
    showStatus('üí° Pronto para formatar! Use Ctrl+Enter como atalho');
  </script>
</body>
</html>
